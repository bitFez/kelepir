{% extends 'temel.html' %}
{% load static %}
{% block content %}
{% load i18n %}
{% load comment_tags %}



<br>

<div class="row">
  {% for kat in katagoriler.all %}
    <a type="button" class="btn-outline-dark btn-lg" href="{% url 'dealcategory' kat.id %}"><i class="{{kat.ikon}}"></i> {{kat.kategori}}</a>
  {% endfor %}
</div>
<br>
<h1>{{h1}}</h1>
<br>


<div class="row">
  <div class="col-sm-9">

      {% for kelepir in kelepirler %}
          <div class="herkelepir">
            {%  include 'madde/partials/madde.html' %}
          </div> 
      {% endfor %}

  </div> <!-- Sol kolon sonu  -->

  <!-- Main page sidebar -->
  <div class="col-sm-3">
    <h5>Haftanın En İyi Kelepirleri</h5>
    <ul class="list-group">
      {% for kelepir in haftanin.all %}
        {% if kelepir.aktif %}
          <li class="list-group-item"><a href="{% url 'madde_detay' kelepir.id %}"><img src="{{kelepir.goruntu.url}}" height=50px alt="">
          {{kelepir.baslik}}</a> - {{kelepir.derece}} puan - {{kelepir.fiyat}}₺</li>
        {% else %}
          <li class="list-group-item" style="color:Grey"><a style="color:Grey" href="{% url 'madde_detay' kelepir.id %}"><img src="{{kelepir.goruntu.url}}" height=50px alt="">
            {{kelepir.baslik}}</a> - {{kelepir.derece}} puan - {{kelepir.fiyat}}₺</li>
        {% endif %}
      {% endfor %}
    </ul>

  </div> <!-- Sag kolon sonu -->
</div> <!-- End of row for both columns -->


      <script type="text/javascript">
      // JQUERY - AJAX SCRIPT FOR voting
      $(document).ready(function(){
        $('.vote_action').click(function(e) {
          //get closest div
          var selector = $(this).closest('div.herkelepir');
          var button = $(this).attr("value");
          var counter = selector.find('.kel_puanlar').attr('id').split('_');
          // get span data
          var maddeid = selector.find("span[id=kelepir_"+counter[1]+"]").attr('data-value');

          console.log("maddeID-->"+maddeid+"Button-->"+button+"counter[1]-->"+counter[1])
          e.preventDefault();
          $.ajax({
            type: 'POST',
            url: '{% url "vote" %}',

            data: {
              maddeid: maddeid,
              csrfmiddlewaretoken: '{{ csrf_token }}',
              action: 'postvote',
              button: button,
            },
            success: function(json){
              if (json.length < 1 || json == undefined) {
                //empty
              }
              //selector.find('.kel_puanlar').text(json['result']);
              $("#puanlar_"+counter[1]).text(json['result']);
              $("#uvb_"+counter[1]).removeClass( "btn btn-success" ).addClass("btn btn-secondary disabled");
              $("#dvb_"+counter[1]).removeClass( "btn btn-danger" ).addClass("btn btn-secondary disabled");
            },
            error: function(xhr, errmsg, err) {}
          })
        })

      })
      </script>
{% endblock %}

{% block scripts %}
{% endblock %}
